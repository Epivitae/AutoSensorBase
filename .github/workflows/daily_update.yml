name: Daily Auto-Update

on:
  schedule:
    - cron: '0 22 * * *' 
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œæœ‰åŠ©äºè§£å†³å¤æ‚çš„åˆå¹¶/å˜åŸºé—®é¢˜

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run ETL pipeline
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: python update_daily.py

      # === ä¿é™©æªæ–½ï¼šå…ˆæŠŠç»“æœå­˜èµ·æ¥ ===
      - name: Upload Artifacts (Data Backup)
        uses: actions/upload-artifact@v4
        with:
          name: etl-data-${{ github.run_id }}
          path: |
            raw_papers.json
            processed_probes.json
          retention-days: 7 # åªä¿ç•™7å¤©ï¼ŒèŠ‚çœç©ºé—´

      - name: Commit and Push changes
        run: |
          git config --global user.name "AutoBot"
          git config --global user.email "bot@example.com"
          
          git add raw_papers.json processed_probes.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Daily ETL Update"
            
            # === å¾ªç¯é‡è¯•æœºåˆ¶ (æœ€å¤šè¯•3æ¬¡) ===
            MAX_RETRIES=3
            count=0
            success=false
            
            until [ $count -ge $MAX_RETRIES ]
            do
              # å°è¯•æ‹‰å–æœ€æ–°ä»£ç  (rebase) å¹¶æ¨é€
              git pull --rebase origin main && git push origin main && success=true && break
              
              # å¦‚æœå¤±è´¥äº†ï¼Œå¢åŠ è®¡æ•°ï¼Œç­‰å¾…å‡ ç§’å†æ¬¡å°è¯•
              count=$((count+1))
              echo "Push failed, retrying in 5 seconds... ($count/$MAX_RETRIES)"
              sleep 5
            done
            
            # å¦‚æœ3æ¬¡éƒ½å¤±è´¥ï¼Œè„šæœ¬æŠ¥é”™ï¼ˆä½†å› ä¸ºä¸Šé¢å·²ç»å­˜æ¡£äº†ï¼Œä½ æ‰‹åŠ¨å»ä¸‹è½½å°±è¡Œï¼‰
            if [ "$success" = false ]; then
              echo "Failed to push after $MAX_RETRIES attempts."
              exit 1
            fi
          fi